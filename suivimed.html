<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuiviMED - Application Patient</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2e86de;
            --secondary-color: #10ac84;
            --accent-color: #ee5253;
            --light-color: #f5f6fa;
            --dark-color: #222f3e;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Menu latéral */
        .sidebar {
            width: 250px;
            background: var(--dark-color);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            background: var(--primary-color);
            text-align: center;
        }
        
        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 10px 0;
        }
        
        .sidebar-menu li {
            padding: 0;
            margin: 5px 0;
        }
        
        .sidebar-menu a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 12px 20px;
            transition: all 0.3s;
        }
        
        .sidebar-menu a:hover, .sidebar-menu a.active {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid var(--secondary-color);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        /* Contenu principal */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }
        
        /* Cartes de dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-header h3 {
            font-size: 1.2rem;
            color: var(--dark-color);
        }
        
        .card-header i {
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        
        .card-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .card-text {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Section de contenu */
        .content-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h2 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        /* Glycémie */
        .glycemie-input {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: #1c6bc2;
        }
        
        /* Conseils */
        .conseils-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .conseil-card {
            background: var(--light-color);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .conseil-card h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .conseil-card p {
            color: #555;
        }
        
        /* Historique */
        .history-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th, .history-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .history-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .history-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-normal {
            background: #e8f5e9;
            color: var(--success-color);
        }
        
        .badge-warning {
            background: #fff8e1;
            color: var(--warning-color);
        }
        
        .badge-danger {
            background: #ffebee;
            color: var(--danger-color);
        }
        
        /* Messages */
        .message-form {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .message-form input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .message-form button {
            padding: 12px 20px;
        }
        
        /* Login Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: var(--primary-color);
        }
        
        .modal-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .modal-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .sidebar-menu {
                display: flex;
                overflow-x: auto;
            }
            
            .sidebar-menu li {
                flex: 0 0 auto;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }
        
        /* Indicateur de glycémie */
        .glycemie-indicator {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .glycemie-normal {
            background: #e8f5e9;
            color: var(--success-color);
        }
        
        .glycemie-hypo {
            background: #fff8e1;
            color: var(--warning-color);
        }
        
        .glycemie-hyper {
            background: #ffebee;
            color: var(--danger-color);
        }
        
        .glycemie-urgence {
            background: #f8d7da;
            color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Loader */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Modal de connexion -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Connexion à SuiviMED</h2>
                <p>Veuillez vous connecter pour accéder à votre espace</p>
            </div>
            <div>
                <input type="tel" id="loginPhone" class="modal-input" placeholder="Votre numéro de téléphone">
                <input type="password" id="loginPassword" class="modal-input" placeholder="Votre mot de passe">
                <button id="loginBtn" class="modal-btn">Se connecter</button>
                <p style="text-align: center; margin-top: 15px; font-size: 14px;">
                    Première fois? Votre médecin vous inscrira.
                </p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Menu latéral -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>SuiviMED</h2>
                <p>Votre santé avant tout</p>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="dashboard"><i class="fas fa-home"></i> Tableau de bord</a></li>
                <li><a href="#" data-section="glycemie"><i class="fas fa-heartbeat"></i> Ma glycémie</a></li>
                <li><a href="#" data-section="conseils"><i class="fas fa-utensils"></i> Conseils nutrition</a></li>
                <li><a href="#" data-section="activite"><i class="fas fa-running"></i> Activité physique</a></li>
                <li><a href="#" data-section="messages"><i class="fas fa-comment-medical"></i> Messages</a></li>
                <li><a href="#" data-section="historique"><i class="fas fa-history"></i> Historique</a></li>
                <li><a href="#" data-section="parametres"><i class="fas fa-cog"></i> Paramètres</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Déconnexion</a></li>
            </ul>
        </div>

        <!-- Contenu principal -->
        <div class="main-content">
            <div class="header">
                <h1>Mon Suivi Diabète</h1>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Patient+Senegal&background=random" alt="User" id="userAvatar">
                    <div>
                        <div id="userName">Invité</div>
                        <small id="userSince"></small>
                    </div>
                </div>
            </div>

            <!-- Section Tableau de bord -->
            <div id="dashboard-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-home"></i> Tableau de bord</h2>
                </div>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <h3>Dernière glycémie</h3>
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="card-value" id="last-glycemie">--</div>
                        <div class="card-text" id="last-glycemie-time">Mesurée: --</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Moyenne sur 7 jours</h3>
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="card-value" id="avg-glycemie">--</div>
                        <div class="card-text" id="glycemie-status">--</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Messages non lus</h3>
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="card-value" id="unread-messages">0</div>
                        <div class="card-text">Dont <span id="doctor-messages">0</span> de votre médecin</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Prochain rendez-vous</h3>
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="card-value" id="next-appointment">--</div>
                        <div class="card-text">Avec <span id="appointment-doctor">--</span></div>
                    </div>
                </div>
                
                <div id="alert-container"></div>
            </div>

            <!-- Section glycémie -->
            <div id="glycemie-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-tint"></i> Enregistrer ma glycémie</h2>
                </div>
                
                <div class="glycemie-input">
                    <div class="input-group">
                        <label for="glycemie-value">Valeur de glycémie (g/L)</label>
                        <input type="number" step="0.01" id="glycemie-value" placeholder="Ex: 1.20">
                    </div>
                    
                    <div class="input-group">
                        <label for="glycemie-type">Type de mesure</label>
                        <select id="glycemie-type">
                            <option value="A jeun">À jeun</option>
                            <option value="Après repas">Après repas</option>
                            <option value="Avant repas">Avant repas</option>
                            <option value="Avant coucher">Avant coucher</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="glycemie-date">Date et heure</label>
                        <input type="datetime-local" id="glycemie-date">
                    </div>
                    
                    <div class="input-group">
                        <label for="glycemie-notes">Notes (optionnel)</label>
                        <input type="text" id="glycemie-notes" placeholder="Ex: Après marche">
                    </div>
                    
                    <button class="btn btn-primary" id="save-glycemie">
                        <i class="fas fa-save"></i> Enregistrer la mesure
                    </button>
                </div>
                
                <div id="glycemie-result" class="glycemie-indicator glycemie-normal">
                    Dernière mesure: --
                </div>
            </div>

            <!-- Section conseils -->
            <div id="conseils-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-utensils"></i> Conseils nutritionnels africains</h2>
                </div>
                
                <div class="conseils-grid">
                    <div class="conseil-card">
                        <h3>Céréales locales</h3>
                        <p>Privilégiez le mil, le sorgho et le maïs entier plutôt que le riz blanc. Le fonio est excellent avec son index glycémique bas.</p>
                    </div>
                    
                    <div class="conseil-card">
                        <h3>Légumes traditionnels</h3>
                        <p>Consommez régulièrement des feuilles de baobab, du niebe, des feuilles de patate douce et du gombo.</p>
                    </div>
                    
                    <div class="conseil-card">
                        <h3>Protéines saines</h3>
                        <p>Poissons gras comme le maquereau, poulet fermier, et légumineuses (niébé, lentilles).</p>
                    </div>
                    
                    <div class="conseil-card">
                        <h3>Fruits locaux</h3>
                        <p>Préférez la papaye, la pastèque (avec modération), et les mangues pas trop mûres. Évitez les fruits séchés très sucrés.</p>
                    </div>
                    
                    <div class="conseil-card">
                        <h3>Cuisson</h3>
                        <p>Évitez les fritures. Préférez la cuisson à l'étouffée, grillée ou au four. Utilisez peu d'huile de palme.</p>
                    </div>
                    
                    <div class="conseil-card">
                        <h3>Activité physique</h3>
                        <p>Marche rapide 30 minutes par jour, jardinage, ou danse traditionnelle sont excellents pour équilibrer la glycémie.</p>
                    </div>
                </div>
            </div>

            <!-- Section historique -->
            <div id="historique-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Historique des mesures</h2>
                </div>
                
                <div id="history-loader" class="loader"></div>
                <table class="history-table" id="history-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Valeur</th>
                            <th>Type</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                    </tbody>
                </table>
            </div>

            <!-- Section messages -->
            <div id="messages-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-comment-medical"></i> Messages avec votre médecin</h2>
                </div>
                
                <div id="messages-container">
                    <p>Chargement des messages...</p>
                </div>
                
                <div class="message-form">
                    <input type="text" id="message-input" placeholder="Tapez votre message...">
                    <button class="btn btn-primary" id="send-message"><i class="fas fa-paper-plane"></i> Envoyer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - NOUVELLE URL
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw6GyEJFHLId76bLzfnvRG-C7I8S1zoDNLjL50QkZioyrQ3936x2inXFuoiYDbsUO-3/exec";
        let currentUser = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier si l'utilisateur est connecté
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            if (authToken && userData) {
                currentUser = JSON.parse(userData);
                initApp();
            } else {
                showLoginModal();
            }
            
            // Gestionnaires d'événements
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('save-glycemie').addEventListener('click', enregistrerGlycemie);
            document.getElementById('send-message').addEventListener('click', sendMessage);
            
            // Navigation dans le menu
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.id !== 'logoutBtn') {
                        showSection(this.getAttribute('data-section'));
                    }
                });
            });
            
            // Initialiser la date et heure actuelles
            document.getElementById('glycemie-date').value = getCurrentDateTime();
        });

        // Fonctions d'API
        async function fetchData(sheet, params = {}) {
            const queryParams = new URLSearchParams({sheet, ...params});
            const response = await fetch(`${WEB_APP_URL}?${queryParams}`);
            return await response.json();
        }

        async function postData(sheet, action, data) {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sheet,
                    action,
                    ...data,
                    token: localStorage.getItem('authToken')
                })
            });
            return await response.json();
        }

        // Fonctions d'authentification
        async function login() {
            const phone = document.getElementById('loginPhone').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!phone || !password) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            try {
                const response = await postData('Gestion Utilisateurs', 'auth', {phone, password});
                
                if (response.status === "success") {
                    // Stocker les informations de session
                    localStorage.setItem('authToken', response.token);
                    localStorage.setItem('userData', JSON.stringify(response.user));
                    
                    currentUser = response.user;
                    hideLoginModal();
                    initApp();
                } else {
                    alert("Identifiants incorrects");
                }
            } catch (error) {
                console.error("Erreur de connexion:", error);
                alert("Erreur de connexion. Vérifiez votre connexion Internet.");
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');
            currentUser = null;
            showLoginModal();
        }

        // Fonctions d'interface
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function initApp() {
            // Mettre à jour l'interface utilisateur
            document.getElementById('userName').textContent = currentUser.nom;
            document.getElementById('userSince').textContent = `Patient depuis: ${currentUser.dateInscription}`;
            document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.nom)}&background=2e86de&color=fff`;
            
            // Charger les données
            loadDashboardData();
            loadHistoryData();
        }

        function showSection(sectionId) {
            // Masquer toutes les sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Afficher la section demandée
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // Mettre à jour le menu
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sidebar-menu a[data-section="${sectionId}"]`).classList.add('active');
            
            // Charger les données spécifiques à la section
            if (sectionId === 'historique') {
                loadHistoryData();
            } else if (sectionId === 'messages') {
                loadMessages();
            }
        }

        // Fonctions de données
        async function loadDashboardData() {
            try {
                // Charger les données du patient
                const data = await fetchData('App Patient SuiviMED', { 
                    action: 'getByPhone', 
                    phone: currentUser.telephone 
                });
                
                if (data && data.length > 0) {
                    // Trier par date et prendre la dernière mesure
                    const sortedData = data.sort((a, b) => new Date(b['Date d\'envoi'] + ' ' + b['Heure d\'envoi']) - new Date(a['Date d\'envoi'] + ' ' + a['Heure d\'envoi']));
                    const lastMeasure = sortedData[0];
                    
                    // Mettre à jour le tableau de bord
                    document.getElementById('last-glycemie').textContent = lastMeasure['Valeur glycémie'] + ' g/L';
                    document.getElementById('last-glycemie-time').textContent = `Mesurée: ${lastMeasure['Date d\'envoi']} à ${lastMeasure['Heure d\'envoi']}`;
                    
                    // Calculer la moyenne sur 7 jours
                    const lastWeekData = sortedData.filter(item => {
                        const measureDate = new Date(item['Date d\'envoi'] + ' ' + item['Heure d\'envoi']);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        return measureDate >= weekAgo;
                    });
                    
                    if (lastWeekData.length > 0) {
                        const sum = lastWeekData.reduce((acc, item) => acc + parseFloat(item['Valeur glycémie']), 0);
                        const avg = (sum / lastWeekData.length).toFixed(2);
                        document.getElementById('avg-glycemie').textContent = avg + ' g/L';
                        
                        // Déterminer le statut
                        if (avg < 0.7) {
                            document.getElementById('glycemie-status').textContent = 'Hypoglycémie';
                            document.getElementById('glycemie-status').style.color = 'var(--warning-color)';
                        } else if (avg > 1.4) {
                            document.getElementById('glycemie-status').textContent = 'Hyperglycémie';
                            document.getElementById('glycemie-status').style.color = 'var(--danger-color)';
                        } else {
                            document.getElementById('glycemie-status').textContent = 'Dans les objectifs';
                            document.getElementById('glycemie-status').style.color = 'var(--success-color)';
                        }
                    }
                    
                    // Mettre à jour l'indicateur de glycémie
                    updateGlycemieDisplay(lastMeasure['Valeur glycémie']);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
            }
        }

        async function loadHistoryData() {
            try {
                document.getElementById('history-loader').style.display = 'block';
                document.getElementById('history-table').style.display = 'none';
                
                const data = await fetchData('App Patient SuiviMED', { 
                    action: 'getByPhone', 
                    phone: currentUser.telephone 
                });
                
                if (data && data.length > 0) {
                    const historyBody = document.getElementById('history-body');
                    historyBody.innerHTML = '';
                    
                    // Trier par date (du plus récent au plus ancien)
                    const sortedData = data.sort((a, b) => new Date(b['Date d\'envoi'] + ' ' + b['Heure d\'envoi']) - new Date(a['Date d\'envoi'] + ' ' + a['Heure d\'envoi']));
                    
                    sortedData.forEach(item => {
                        const row = document.createElement('tr');
                        
                        const valeur = parseFloat(item['Valeur glycémie']);
                        let statusClass = 'badge-normal';
                        let statusText = 'Normal';
                        
                        if (valeur < 0.7) {
                            statusClass = 'badge-warning';
                            statusText = 'Hypo';
                        } else if (valeur > 1.4) {
                            statusClass = 'badge-danger';
                            statusText = 'Hyper';
                        }
                        
                        row.innerHTML = `
                            <td>${item['Date d\'envoi']} ${item['Heure d\'envoi']}</td>
                            <td>${item['Valeur glycémie']} g/L</td>
                            <td>${item['Type Mesure'] || ''}</td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                        `;
                        
                        historyBody.appendChild(row);
                    });
                    
                    document.getElementById('history-loader').style.display = 'none';
                    document.getElementById('history-table').style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'historique:', error);
                document.getElementById('history-loader').style.display = 'none';
            }
        }

        async function loadMessages() {
            // À implémenter: Charger les messages depuis le serveur
            document.getElementById('messages-container').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <i class="fas fa-comment-slash" style="font-size: 48px; color: #ccc; margin-bottom: 15px;"></i>
                    <p>Aucun message pour le moment</p>
                </div>
            `;
        }

        // Fonctions de gestion de la glycémie
        async function enregistrerGlycemie() {
            const valeur = document.getElementById('glycemie-value').value;
            const type = document.getElementById('glycemie-type').value;
            const date = document.getElementById('glycemie-date').value;
            const notes = document.getElementById('glycemie-notes').value;
            
            if (!valeur) {
                alert('Veuillez entrer une valeur de glycémie');
                return;
            }
            
            try {
                const result = await postData('App Patient SuiviMED', 'add', {
                    "ID Patient": currentUser.id,
                    "Téléphone": currentUser.telephone,
                    "Date d'envoi": formatDateForSheets(new Date()),
                    "Heure d'envoi": formatTimeForSheets(new Date()),
                    "Valeur glycémie": valeur,
                    "Type Mesure": type,
                    "Statut": "enregistré",
                    "Message vocal": "",
                    "Conduite à tenir": notes || ""
                });
                
                if (result.status === "ok") {
                    // Mettre à jour l'interface
                    updateGlycemieDisplay(valeur);
                    
                    // Réinitialiser le formulaire
                    document.getElementById('glycemie-value').value = '';
                    document.getElementById('glycemie-notes').value = '';
                    document.getElementById('glycemie-date').value = getCurrentDateTime();
                    
                    // Recharger les données
                    loadDashboardData();
                    loadHistoryData();
                    
                    alert('Mesure enregistrée avec succès!');
                } else {
                    alert('Erreur lors de l\'enregistrement: ' + result.message);
                }
            } catch (error) {
                console.error("Erreur:", error);
                alert("Erreur lors de l'enregistrement. Vérifiez votre connexion.");
            }
        }

        function updateGlycemieDisplay(valeur) {
            const valeurNum = parseFloat(valeur);
            const resultElement = document.getElementById('glycemie-result');
            
            // Déterminer le statut
            if (valeurNum < 0.5) {
                resultElement.className = 'glycemie-indicator glycemie-urgence';
                resultElement.innerHTML = `Dernière mesure: ${valeur} g/L (URGENCE: Hypoglycémie sévère) - Contactez immédiatement un médecin!`;
                showAlert('urgence', 'Hypoglycémie sévère', 'Consultez immédiatement un médecin!');
            } else if (valeurNum < 0.7) {
                resultElement.className = 'glycemie-indicator glycemie-hypo';
                resultElement.innerHTML = `Dernière mesure: ${valeur} g/L (Hypoglycémie) - Consommez rapidement du sucre`;
                showAlert('warning', 'Hypoglycémie', 'Consommez rapidement du sucre (jus de fruit, sucre, miel)');
            } else if (valeurNum >= 0.7 && valeurNum <= 1.4) {
                resultElement.className = 'glycemie-indicator glycemie-normal';
                resultElement.innerHTML = `Dernière mesure: ${valeur} g/L (Normal)`;
            } else if (valeurNum > 1.4 && valeurNum <= 1.8) {
                resultElement.className = 'glycemie-indicator glycemie-hyper';
                resultElement.innerHTML = `Dernière mesure: ${valeur} g/L (Hyperglycémie modérée) - Surveillez votre alimentation`;
                showAlert('warning', 'Hyperglycémie modérée', 'Surveillez votre alimentation et hydratez-vous bien');
            } else {
                resultElement.className = 'glycemie-indicator glycemie-urgence';
                resultElement.innerHTML = `Dernière mesure: ${valeur} g/L (URGENCE: Hyperglycémie sévère) - Contactez immédiatement un médecin!`;
                showAlert('urgence', 'Hyperglycémie sévère', 'Contactez immédiatement un médecin!');
            }
        }

        function showAlert(type, title, message) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `glycemie-indicator glycemie-${type}`;
            alertDiv.innerHTML = `
                <strong>${title}:</strong> ${message}
            `;
            alertContainer.appendChild(alertDiv);
            
            // Supprimer l'alerte après 10 secondes
            setTimeout(() => {
                alertDiv.remove();
            }, 10000);
        }

        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) {
                alert('Veuillez entrer un message');
                return;
            }
            
            // À implémenter: Envoyer le message au serveur
            alert('Fonctionnalité de messagerie à implémenter');
            messageInput.value = '';
        }

        // Fonctions utilitaires
        function getCurrentDateTime() {
            const now = new Date();
            return now.toISOString().slice(0, 16);
        }

        function formatDateForSheets(date) {
            return date.toLocaleDateString('fr-FR');
        }

        function formatTimeForSheets(date) {
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
    </script>
</body>
</html>